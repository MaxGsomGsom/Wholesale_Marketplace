@model Wholesale_Marketplace.Models.Dialog_dispute
@using Wholesale_Marketplace.Models

@{
    ViewBag.Title = "Диалог";
    if (ViewBag.RoleID == 0) { Layout = "~/Views/Shared/BuyerLayout.cshtml"; }
}


<script>
    var CheckMessages = function () {
        $.post("ShowNewMessages", {id: @Model.DisputeID, lastTime: lastTimeCheck}, function(data, textStatus, jqXHR) {
            $("#messagesContainer").append(data);
            lastTimeCheck = Date.now();
        })
    }
    var lastTimeCheck = 0;

    $(document).ready(function () {
        CheckMessages();
        setInterval(CheckMessages, 1000);

        $("#postMessageForm").submit(function() {

            var formData = new FormData($(this)[0]);

            $.ajax({
                url: "/Dialog/PostMessage",
                type: "POST",
                data: formData,
                async: false,
                success: null,
                cache: false,
                contentType: false,
                processData: false

            })

            //$.post("/Dialog/PostMessage", { Text: $("#postMessageText")[0].value, DisputeID: @Model.DisputeID }, function(){});


            $("#postMessageText")[0].value = "";
            return false;
        })
    })
</script>

<div class="field-main">
    <div class="col-md-8">
        @if (Model.Seller != null)
        {
            <div class="row" style="padding-left:1em">
                <div class="row">
                    <h3><b>@Model.Seller.Store.Name</b></h3>
                </div>
                <div class="row">
                    <div class="col-md-2" style="padding-left:0px">@Helpers.Stars(Convert.ToInt32(Model.Seller.Store.Average_mark))</div>
                    <div class="col-md-2">@Model.Seller.Store.Orders_count заказов</div>
                </div>
            </div>
        }
        
        <div class="row" id="messagesContainer">

        </div>
        <div class="row">
            <form action="PostMessage" method="post" id="postMessageForm">
                <input type="number" name="DisputeID" value="@Model.DisputeID"  style="display:none"/>
                <div class="row"><input type="text" name="Text" value=" " id="postMessageText"/></div>
                <div class="row">
                    <input type="submit" class="btn btn-primary" value="Отправить" />
                    <input type="file" name="messageImage" value=" " />
                </div>
            </form>
        </div>
    </div>
    @if (Model.Order != null) { 
    <div class="col-md-4">
        <div class="row">@Model.Order.Item.Name</div>
        <div class="row"><img class=" img-rounded" id="MainImg" src="~/Item/Photo?id=@((Model.Order.Item.Pictures.Count > 0) ? (Model.Order.Item.Pictures.First().PictureID) : -1)" style=" max-height:100px"></div>
        <div class="row"><a href="/Order/Info?id=@Model.Order.OrderID" role="button" class="btn btn-default">Посмотреть заказ</a></div>
        <div class="row">   </div>
    </div>
    }
</div>

